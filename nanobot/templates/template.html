<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
	<link rel="stylesheet" href="{{ url_for('static', filename='bstreeview.css') }}">
	<link rel="stylesheet" href="{{ url_for('static', filename='ols-autocomplete.css') }}">
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/corejs-typeahead/0.11.1/typeahead.bundle.min.js"></script>
	<script src="{{ url_for('static', filename='bstreeview.js') }}"></script>
	<script src="{{ url_for('static', filename='ols-autocomplete.js') }}"></script>
	<title>{{ project_name }}</title>
</head>
<body>
	<nav class="navbar navbar-expand-lg navbar-light bg-light">
		<div class="container-fluid">
			<a class="navbar-brand">{{ project_name }}</a>
			<div class="collapse navbar-collapse">
<!--				Ontologies section is not used in this use case		-->
<!--			{% if ontologies %}-->
<!--			<ul class="navbar-nav">-->
<!--				<li class="nav-item dropdown">-->
<!--					<a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">-->
<!--						Ontologies-->
<!--					</a>-->
<!--					<ul class="dropdown-menu">-->
<!--						{% for o in ontologies %}-->
<!--						<li><a class="dropdown-item" href="{{ url_for('cmi-pb.table', table_name=o, view='tree') }}">{{ o }}</a></li>-->
<!--						{% endfor %}-->
<!--					</ul>-->
<!--				</li>-->
<!--			</ul>-->
<!--			{% endif %}-->
			<ul class="navbar-nav">
				<li class="nav-item dropdown">
					<a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
						Tables
					</a>
					<ul class="dropdown-menu">
						{% for t in tables %}
						<li><a class="dropdown-item" href="{{ url_for('cmi-pb.table', table_name=t) }}">{{ t }}</a></li>
						{% endfor %}
					</ul>
				</li>
			</ul>
			</div>
		</div>
	</nav>
	<div id="cmi-pb" class="px-5 py-1">
		{% if show_search %}
		<div class="row">
			<form class="form-row mt-2 mb-2" method="get">
				<input id="statements-typeahead" name="text" class="typeahead form-control" type="text" value="" placeholder="Search"/>
			</form>
		</div>
		{% endif %}
		<div class="row" style="padding-top:10px;">
			{% if title %}
			<div class="row">
				<h2>{{ title|safe }}</h2>
				{% if subtitle %}
				<br><p class="lead">{{ subtitle|safe }}</p>
				{% endif %}
			</div>
			{% endif %}
			<div class="row">
			{{ html|safe }}
			{% block content %}
            {% endblock %}
			</div>
		</div>
	</div>
</body>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/typeahead.js/0.11.1/typeahead.bundle.min.js"></script>
<script>
	$(document).ready(function() {
	  var app = require("ols-autocomplete");
	  var instance = new app();
	  $('.ebi-autocomplete').each(function(i, obj) {
	  	// disable all id fields associated with a autocomplete name field
	  	autocomplete_input_name = obj.name;
	  	target_input_name = autocomplete_input_name.replace("_name", "_id");
	  	$('input[name="' + target_input_name + '"]')[0].readOnly = true
	  });

	  options={action : function(relativePath, suggestion_ontology, type, iri, data){
		console.log("In overwritten function")
		console.log("Relative Path: "+relativePath)
		console.log("Suggested Ontology: "+suggestion_ontology)
		console.log("Type (optional): "+type)
		console.log("iri (optional): "+iri)
		console.log("Whole data element (optional+new): ")
		console.log(data)
		console.log(document.activeElement)
		console.log("Field-id: " + $('.ebi-autocomplete:focus'))
	  }
	}
	  instance.start(options)
	});

	function show_children() {
		/**
		 * Redirect to sprocket table search results when clicking view all children.
		 * This overrides gadget default behavior.
		 */
		var curURL = window.location.href;
		var tableURL = curURL.substr(0, curURL.lastIndexOf("/"));
		var termId = curURL.substr(curURL.lastIndexOf("/") + 1);
		if (termId.includes("?")) {
			termId = termId.split("?")[0];
		}
		if (termId === "{{ table_name }}") {
			termId = "owl:Thing";
			tableURL = tableURL + "/{{ table_name }}";
		}
		if (termId == "owl:Class") {
			termId = "owl:Thing";
		}
		var url = new URL(tableURL);
		url.searchParams.append("subClassOf", termId);
		window.location = url;
	}

	// Configure typeahead for data table autocomplete
	function configure_typeahead_form(node) {
		if (!node.id || !node.id.endsWith("-typeahead-form")) {
		  return;
		}
		var col = node.id.split("-")[0];
		var bloodhound = new Bloodhound({
		  datumTokenizer: Bloodhound.tokenizers.obj.nonword('label'),
		  queryTokenizer: Bloodhound.tokenizers.nonword,
		  sorter: function(a, b) {
			return a.order - b.order;
		  },
		  remote: {
			url: '{{ url_for("cmi-pb.table", table_name=table_name) }}' + `?text=%QUERY&column=${col}&format=json`,
			wildcard: '%QUERY',
			transform : function(response) {
			  return bloodhound.sorter(response);
			}
		  }
		});
		$(node).typeahead({
		  minLength: 0,
		  hint: false,
		  highlight: true
		}, {
		  name: "{{ table_name }}",
		  source: bloodhound,
		  display: function(item) {
			return item.label;
		  },
		  limit: 40
		});
		$(node).bind('click', function(e) {
		  $(node).select();
		});
		var cls = node.className;
		if (cls.includes("is-invalid")) {
			var parent = node.parentElement;
			var parentCls = parent.className;
			parent.className = parentCls + " is-invalid";
		}
	}

	// Configure typeahead for search
	function configure_typeahead(node) {
	  if (!node.id || !node.id.endsWith("-typeahead")) {
		return;
	  }
	  table = node.id.split("-")[0];
	  var bloodhound = new Bloodhound({
		datumTokenizer: Bloodhound.tokenizers.obj.nonword('short_label', 'label', 'synonym'),
		queryTokenizer: Bloodhound.tokenizers.nonword,
		sorter: function(a, b) {
		  return a.order - b.order;
		},
		remote: {
		  {% if search_param %}
		  url: '{{ url_for("cmi-pb.table", table_name=table_name) }}' + '?{{ search_param }}&text=%QUERY&format=json'
		  {% else %}
		  url: '{{ url_for("cmi-pb.table", table_name=table_name) }}' + '?text=%QUERY&format=json', {% endif %}
		  wildcard: '%QUERY',
		  transform : function(response) {
			  return bloodhound.sorter(response);
		  }
		}
	  });
	  $(node).typeahead({
		minLength: 0,
		hint: false,
		highlight: true
	  }, {
		name: table,
		source: bloodhound,
		display: function(item) {
		  return item.label;
		},
		limit: 40
	  });
	  $(node).bind('click', function(e) {
		$(node).select();
	  });
	  $(node).bind('typeahead:select', function(ev, suggestion) {
		$(node).prev().val(suggestion.id);
		go(table, suggestion.id);
	  });
	}
	$('.typeahead').each(function() { configure_typeahead(this); });
	$('.typeahead').each(function() { configure_typeahead_form(this); });

	function go(table, value) {
	  q = {}
	  q[table] = value
	  window.location = query(q);
	}

	function query(obj) {
	  var url = "";
	  for (var p in obj)
		if (obj.hasOwnProperty(p)) {
		  url = "{{ url_for('cmi-pb.table', table_name=table_name) }}/" + encodeURIComponent(obj[p]);
		}
	  ele = document.getElementById("gadgetTree");
	  if (ele !== null) {
	  	url += "?view=tree";
	  }
	  return url;
	}

	// Icon change for hovering on ontology form delete buttons
	var deletes = document.getElementsByClassName("bi-x-circle");
	for (var i = 0; i < deletes.length; i++){
		deletes[i].onmouseenter = (function(delBtn) {
			return function() { delBtn.setAttribute("class", "bi-x-circle-fill"); }
		})(deletes[i]);
		deletes[i].onmouseleave = (function(delBtn) {
			return function() { delBtn.setAttribute("class", "bi-x-circle"); }
		})(deletes[i]);
	}

	// Add & edit button support
	{% if add_btn or edit_btn %}
	var container = document.getElementById("cmi-pb");
	var includeNew = false;

	{% if add_btn %}
	// {{ add_btn['url'] }}
	includeNew = true;
	var btn = document.createElement("a");
	btn.setAttribute("data-bs-toggle", "tooltip");
	btn.setAttribute("data-bs-placement", "left");
	console.log("{{ add_btn['url'] }}");
	btn.setAttribute("href", "{{ add_btn['url'] }}".replace(/&amp;/g, "&"));
	btn.setAttribute("class", "btn btn-primary float btn-xl-plus");
	btn.setAttribute("title", "{{ add_btn['text'] }}");
	btn.innerHTML = '<i class="bi-plus"></i>';
	container.parentElement.insertBefore(btn, container);
	{% endif %}

	{% if edit_btn %}
	var btn = document.createElement("a");
	btn.setAttribute("data-bs-toggle", "tooltip");
	btn.setAttribute("data-bs-placement", "left");
	btn.setAttribute("href", "{{ edit_btn['url'] }}".replace(/&amp;/g, "&"));
	if (includeNew) {
		btn.setAttribute("class", "btn btn-primary float-above btn-xl-pencil");
	} else {
		btn.setAttribute("class", "btn btn-primary float btn-xl-pencil");
	}
	btn.setAttribute("title", "{{ edit_btn['text'] }}");
	btn.innerHTML = '<i class="bi-pencil"></i>';
	container.parentElement.insertBefore(btn, container);
	{% endif %}
	{% endif %}

	// Enable tooltips
	var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
	var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
	  return new bootstrap.Tooltip(tooltipTriggerEl)
	})
</script>
</html>